name: Builder

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12' # 指定你的 Python 版本，例如 '3.9' 或 '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller # 安装 PyInstaller
        # 如果你有 requirements.txt 文件，在这里安装你的项目依赖
        pip install -r requirements.txt

    - name: Run PyInstaller
      run: |
        # 替换 'your_script_name.py' 为你的主脚本文件
        # 可以添加更多 PyInstaller 选项，例如 --onefile, --windowed 等
        pyinstaller main.py `
          --onedir `
          --noconsole `
          --name MusicDownloader `
          --ico=icon.ico

    - name: Copy UI Resources (Post-processing)
      run: |
        # 确保目标目录存在，Copy-Item -Recurse 在复制目录时如果目标不存在会自动创建，
        # 但如果目标是文件而不是目录时，可能需要预先创建目标父目录
        # 这里为了稳妥，我们可以在复制之前先创建一个空目录（如果它不存在）
        New-Item -ItemType Directory -Force -Path "dist/MusicDownloader/ui/resources"
        
        # 使用 Copy-Item 复制内容
        # 注意：这里我们只复制 ui/resources 目录内部的文件和子目录，而不是 ui/resources 本身
        # 因为目标路径是 dist/MusicDownloader/ui/resources
        Copy-Item -Path "ui/resources/*" -Destination "dist/MusicDownloader/ui/resources" -Recurse -Force
      shell: pwsh # 明确指定使用 PowerShell

    - name: Install Inno Setup
      run: choco install innosetup --no-progress --yes

    - name: Compile Installer with Inno Setup
      run: iscc inno_setup.iss
      shell: cmd

    - name: Upload Installer Artifact
      uses: actions/upload-artifact@v4
      with:
        name: MusicDownloader-Installer
        path: Output/MusicDownloader-Setup.exe

    - name: Upload Application Files
      uses: actions/upload-artifact@v4
      with:
        name: MusicDownloader-Application
        path: dist/MusicDownloader
